<?php

class Dsm5 {

    public $questions = [
        "questions"=> [
            "1" => "I don't get as much pleasure out of things as others seem to",
            "2" => "Plenty of people are out to get me",
            "3" => "People would describe me as reckless",
            "4"=>"I feel like I act totally on impulse",
            "5"=>"I often have ideas that are too unusual to explain to anyone",
            "6"=>"I lose track of conversations because other things catch my attention",
            "7"=>"I avoid risky situations",
            "8"=>"When it comes to my emotions, people tell me I'm a \"cold fish\"",
            "9"=>"I change what I do depending on what others want",
            "10"=>"I prefer not to get too close to people",
            "11"=>"I often get into physical fights",
            "12"=>"I dread being without someone to love me",
            "13"=>"Being rude and unfriendly is just a part of who I am",
            "14"=>"I do things to make sure people notice me",
            "15"=>"I usually do what others think I should do",
            "16"=>"I usually do things on impulse without thinking about what might happen as a result",
            "17"=>"Even though I know better, I can't stop making rash decisions",
            "18"=>"My emotions sometimes change for no good reason",
            "19"=>"I really don't care if I make other people suffer",
            "20"=>"I keep to myself",
            "21"=>"I often say things that others find odd or strange",
            "22"=>"I always do things on the spur of the moment",
            "23"=>"Nothing seems to interest me very much",
            "24"=>"Other people seem to think my behavior is weird",
            "25"=>"People have told me that I think about things in a really strange way",
            "26"=>"I almost never enjoy life",
            "27"=>"I often feel like nothing I do really matters",
            "28"=>"I snap at people when they do little things that irritate me",
            "29"=>"I can't concentrate on anything",
            "30"=>"I'm an energetic person",
            "31"=>"Others see me as irresponsible",
            "32"=>"I can be mean when I need to be",
            "33"=>"My thoughts often go off in odd or unusual directions",
            "34"=>"I've been told I spend too much time making sure things are exactly in place",
            "35"=>"I avoid risky sports and activities",
            "36"=>"I can have trouble telling the difference between dreams and waking life",
            "37"=>"Sometimes I get this weird feeling that parts of my body feel like they're dead or not really me",
            "38"=>"I am easily angered",
            "39"=>"I have no limits when it comes to doing dangerous things",
            "40"=>"To be honest, I'm just more important than other people",
            "41"=>"I make up stories about things that happened that are totally untrue",
            "42"=>"People often talk about me doing things I don't remember at all",
            "43"=>"I do things so that people just have to admire me",
            "44"=>"It's weird, but sometimes ordinary objects seem to be a different shape than usual",
            "45"=>"I don't have very long-lasting emotional reactions to things",
            "46"=>"It's hard for me to stop an activity, even when it's time to do so",
            "47"=>"I'm not good at planning ahead",
            "48"=>"I do a lot of things that others consider risky",
            "49"=>"People tell me that I focus too much on minor details",
            "50"=>"I worry a lot about being alone",
            "51"=>"I've missed out on things because I was busy trying to get something I was doing exactly right",
            "52"=>"My thoughts often don't make sense to others",
            "53"=>"I often make up things about myself to help me get what I want",
            "54"=>"It doesn't really bother me to see other people get hurt",
            "55"=>"People often look at me as if I'd said something really weird",
            "56"=>"People don't realize that I'm flattering them to get something",
            "57"=>"I'd rather be in a bad relationship than be alone",
            "58"=>"I usually think before I act",
            "59"=>"I often see vivid dream-like images when I'm falling asleep or waking up",
            "60"=>"I keep approaching things the same way, even when it isn't working",
            "61"=>"I'm very dissatisfied with myself",
            "62"=>"I have much stronger emotional reactions than almost everyone else",
            "63"=>"I do what other people tell me to do",
            "64"=>"I can't stand being left alone, even for a few hours",
            "65"=>"I have outstanding qualities that few others possess",
            "66"=>"The future looks really hopeless to me",
            "67"=>"I like to take risks",
            "68"=>"I can't achieve goals because other things capture my attention",
            "69"=>"When I want to do something, I don't let the possibility that it might be risky stop me",
            "70"=>"Others seem to think I'm quite odd or unusual",
            "71"=>"My thoughts are strange and unpredictable",
            "71"=>"I don't care about other people's feelings",
            "73"=>"You need to step on some toes to get what you want in life",
            "74"=>"I love getting the attention of other people",
            "75"=>"I go out of my way to avoid any kind of group activity",
            "76"=>"I can be sneaky if it means getting what I want",
            "77"=>"Sometimes when I look at a familiar object, it's somehow like I'm seeing it for the first time",
            "78"=>"It's hard for me to shift from one activity to another",
            "79"=>"I worry a lot about terrible things that might happen",
            "80"=>"I have trouble changing how I'm doing something even if what I'm doing isn't going well",
            "81"=>"The world would be better off if I were dead",
            "82"=>"I keep my distance from people",
            "83"=>"I often can't control what I think about",
            "84"=>"I don't get emotional",
            "85"=>"I resent being told what to do, even by people in charge",
            "86"=>"I'm so ashamed of how I've let people down in lots of little ways",
            "87"=>"I avoid anything that might be even a little bit dangerous",
            "88"=>"I have trouble pursuing specific goals even for short periods of time",
            "89"=>"I prefer to keep romance out of my life",
            "90"=>"I would never harm another person",
            "91"=>"I don't show emotions strongly",
            "92"=>"I have a very short temper",
            "93"=>"I often worry that something bad will happen due to mistakes I made in the past",
            "94"=>"I have some unusual abilities, like sometimes knowing exactly what someone is thinking",
            "95"=>"I get very nervous when I think about the future",
            "96"=>"I rarely worry about things",
            "97"=>"I enjoy being in love",
            "98"=>"I prefer to play it safe rather than take unnecessary chances",
            "99"=>"I sometimes have heard things that others couldn't hear",
            "100"=>"I get fixated on certain things and can't stop",
            "101"=>"People tell me it's difficult to know what I'm feeling",
            "102"=>"I am a highly emotional person",
            "103"=>"Others would take advantage of me if they could",
            "104"=>"I often feel like a failure",
            "105"=>"If something I do isn't absolutely perfect, it's simply not acceptable",
            "106"=>"I often have unusual experiences, such as sensing the presence of someone who isn't actually there",
            "107"=>"I'm good at making people do what I want them to do",
            "108"=>"I break off relationships if they start to get close",
            "109"=>"I'm always worrying about something",
            "110"=>"I worry about almost everything",
            "111"=>"I like standing out in a crowd",
            "112"=>"I don't mind a little risk now and then",
            "113"=>"My behavior is often bold and grabs peoples' attention",
            "114"=>"I'm better than almost everyone else",
            "115"=>"People complain about my need to have everything all arranged",
            "116"=>"I always make sure I get back at people who wrong me",
            "117"=>"I'm always on my guard for someone trying to trick or harm me",
            "118"=>"I have trouble keeping my mind focused on what needs to be done",
            "119"=>"I talk about suicide a lot",
            "120"=>"I'm just not very interested in having sexual relationships",
            "121"=>"I get stuck on things a lot",
            "122"=>"I get emotional easily, often for very little reason",
            "123"=>"Even though it drives other people crazy, I insist on absolute perfection in everything I do",
            "124"=>"I almost never feel happy about my day-to-day activities",
            "125"=>"Sweet-talking others helps me get what I want",
            "126"=>"Sometimes you need to exaggerate to get ahead",
            "127"=>"I fear being alone in life more than anything else",
            "128"=>"I get stuck on one way of doing things, even when it's clear it won't work",
            "129"=>"I'm often pretty careless with my own and others' things",
            "130"=>"I am a very anxious person",
            "131"=>"People are basically trustworthy",
            "132"=>"I am easily distracted",
            "133"=>"It seems like I'm always getting a \"raw deal\" from others",
            "134"=>"I don't hesitate to cheat if it gets me ahead",
            "135"=>"I check things several times to make sure they are perfect",
            "136"=>"I don't feel like spending time with others",
            "137"=>"I feel compelled to go on with things even when it makes little sense to do so",
            "138"=>"I never know where my emotions will go from moment to moment",
            "139"=>"I have seen things that weren't really there",
            "140"=>"It is important to me that things are done in a certain way",
            "141"=>"I always expect the worst to happen",
            "142"=>"I try to tell the truth even when it's hard",
            "143"=>"I believe that some people can move things with their minds",
            "144"=>"I can't focus on things for very long",
            "145"=>"I steer clear of romantic relationships",
            "146"=>"I'm not interested in making friends",
            "147"=>"I say as little as possible when dealing with people",
            "148"=>"I'm useless as a person",
            "149"=>"I'll do just about anything to keep someone from abandoning me",
            "150"=>"Sometimes I can influence other people just by sending my thoughts to them",
            "151"=>"Life looks pretty bleak to me",
            "152"=>"I think about things in odd ways that don't make sense to most people",
            "153"=>"I don't care if my actions hurt others",
            "154"=>"Sometimes I feel \"controlled\" by thoughts that belong to someone else",
            "155"=>"I really live life to the fullest",
            "156"=>"I make promises that I don't really intend to keep",
            "157"=>"Nothing seems to make me feel good",
            "158"=>"I get irritated easily by all sorts of things",
            "159"=>"I do what I want regardless of how unsafe it might be",
            "160"=>"I often forget to pay my bills",
            "161"=>"I don't like to get too close to people",
            "162"=>"I'm good at conning people",
            "163"=>"Everything seems pointless to me",
            "164"=>"I never take risks",
            "165"=>"I get emotional over every little thing",
            "166"=>"It's no big deal if I hurt other peoples' feelings",
            "167"=>"I never show emotions to others",
            "168"=>"I often feel just miserable",
            "169"=>"I have no worth as a person",
            "170"=>"I am usually pretty hostile",
            "171"=>"I've skipped town to avoid responsibilities",
            "172"=>"I've been told more than once that I have a number of odd quirks or habits",
            "173"=>"I like being a person who gets noticed",
            "174"=>"I'm always fearful or on edge about bad things that might happen",
            "175"=>"I never want to be alone",
            "176"=>"I keep trying to make things perfect, even when I've gotten them as good as they're likely to get",
            "177"=>"I rarely feel that people I know are trying to take advantage of me",
            "178"=>"I know I'll commit suicide sooner or later",
            "179"=>"I've achieved far more than almost anyone I know",
            "180"=>"I can certainly turn on the charm if I need to get my way",
            "181"=>"My emotions are unpredictable",
            "182"=>"I don't deal with people unless I have to",
            "183"=>"I don't care about other peoples' problems",
            "184"=>"I don't react much to things that seem to make others emotional",
            "185"=>"I have several habits that others find eccentric or strange",
            "186"=>"I avoid social events",
            "187"=>"I deserve special treatment",
            "188"=>"It makes me really angry when people insult me in even a minor way",
            "189"=>"I rarely get enthusiastic about anything",
            "190"=>"I suspect that even my so-called \"friends\" betray me a lot",
            "191"=>"I crave attention",
            "192"=>"Sometimes I think someone else is removing thoughts from my head",
            "193"=>"I have periods in which I feel disconnected from the world or from myself",
            "194"=>"I often see unusual connections between things that most people miss",
            "195"=>"I don't think about getting hurt when I'm doing things that might be dangerous",
            "196"=>"I simply won't put up with things being out of their proper places",
            "197"=>"I often have to deal with people who are less important than me",
            "198"=>"I sometimes hit people to remind them who's in charge",
            "199"=>"I get pulled off-task by even minor distractions",
            "200"=>"I enjoy making people in control look stupid",
            "201"=>"I just skip appointments or meetings if I'm not in the mood",
            "202"=>"I try to do what others want me to do",
            "203"=>"I prefer being alone to having a close romantic partner",
            "204"=>"I am very impulsive",
            "205"=>"I often have thought that make sense to me but that other people say are strange",
            "206"=>"I use people to get what I want",
            "207"=>"I don't see the point in feeling guilty about things I've done that have hurt other people",
            "208"=>"Most of the time I don't see the point in being friendly",
            "209"=>"I've had some really weird experiences that are very difficult to explain",
            "210"=>"I follow through on commitments",
            "211"=>"I like to draw attention to myself",
            "212"=>"I feel guilty much of the time",
            "213"=>"I often \"zone out\" and then suddenly come to and realize that a lot of time has passed",
            "214"=>"Lying comes easily to me",
            "215"=>"I hate to take chances",
            "216"=>"I'm nasty and short to anybody who deserves it",
            "217"=>"Things around me often feel unreal, or more real than usual",
            "218"=>"I'll stretch the truth if it's to my advantage",
            "219"=>"It is easy for me to take advantage of others",
            "220"=>"I have a strict way of doing things" 
        ]   
    ];

    private $responses;

    private $results;

    private $scoresToReverse = [7,30,35,58,87,90,96,97,98,131,142,155,164,177,210,215];

    private $error = [
        'error'=>[
            'message'=>''
        ]
    ];

    private $facets = [
        'Anhedonia'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[1,23,26,30,124,155,157,189]
        ],
        'Anxiousness'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[79,93,95,96,109,110,130,141,174]
        ],
        'Attention Seeking'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[14,43,74,111,113,173,191,211]
        ],
        'Callousness'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[11,13,19,54,72,73,90,153,166,183,198,200,207,208]
        ],
        'Deceitfulness'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[41,53,56,76,126,134,142,206,214,218]
        ],
        'Depressivity'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[27,61,66,81,86,104,119,148,151,163,168,169,178,212]
        ],
        'Distractibility'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[6,29,47,68,88,118,132,144,199]
        ],
        'Eccentricity'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[5,21,24,25,33,52,55,70,71,152,172,185,205]
        ],
        'Emotional Liability'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[18,62,102,122,138,165,181]
        ],
        'Grandiosity'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[40,65,114,179,187,197]
        ],
        'Hostility'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[28,32,38,85,92,116,158,170,188,216]
        ],
        'Impulsivity'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[4,16,17,22,58,204]
        ],
        'Intimacy Avoidance'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[89,97,108,120,145,203]
        ],
        'Irresponsibility'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[31,129,156,160,171,201,210]
        ],
        'Manipulativeness'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[107,125,162,180,219]
        ],
        'Perceptual Dysregulation'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[36,37,42,44,59,77,83,154,192,193,213,217]
        ],
        'Perseveration'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[46,51,60,78,80,100,121,128,137]
        ],
        'Restricted Affectivity'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[8,45,84,91,101,167,184]
        ],
        'Rigid Perfectionism'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[34,49,105,115,123,135,140,176,196,220]
        ],
        'Risk Taking'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[3,7,35,39,48,67,69,87,98,112,159,164,195,215]
        ],
        'Separation Insecurity'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[12,50,57,64,127,149,175]
        ],
        'Submissiveness'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[9,15,63,202]
        ],
        'Suspiciousness'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[2,103,117,131,133,177,190]
        ],
        'Unusual Beliefs And Experiences'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[94,99,106,139,143,150,194,209]
        ],
        'Withdrawal'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'questions'=>[10,20,75,82,136,146,147,161,182,186]
        ]
    ];

    private $domains = [
        'Negative Affect'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'facets'=>['Emotional Liability','Anxiousness','Separation Insecurity']
        ],
        'Detachment'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'facets'=>['Withdrawal','Anhedonia','Intimacy Avoidance']
        ],
        'Antagonism'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'facets'=>['Manipulativeness','Deceitfulness','Grandiosity']
        ],
        'Disinhibition'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'facets'=>['Irresponsibility','Impulsivity','Distractibility']
        ],
        'Psychoticism'=>[
            'raw'=>0.0,
            'average'=>0.0,
            'facets'=>['Unusual Beliefs And Experiences','Eccentricity','Perceptual Dysregulation']
        ]
    ];

    public function GetQuestions(){
        return json_encode($this->questions);
    }

    public function ScoreTest($data){
       json_decode($data, true);
       $this->responses = (json_decode($data, true));
        
        if(!$this->ValidateInput()){
            $this->error['error']['message'] = 'Error: Invalid response';
            return json_encode($this->error);
        }

        $this->ReverseScores();
        $this->CalculateFacets();
        $this->CalculateDomains();
        $this->GenerateResponse();
        
        return $this->results;
    }


    private function ValidateInput(){

        foreach($this->responses['responses'] as $number => $answer){
            if(!is_numeric($answer) || $answer < 0 || $answer > 4){
                return false;
            }
        }
        return true;
    }


    private function ReverseScores(){  

        foreach($this->scoresToReverse as $question){
            switch($this->responses['responses'][$question])
            {
                case 0:
                    $this->responses['responses'][$question] = 3;
                    break;
                case 1:
                    $this->responses['responses'][$question] = 2;
                    break;
                case 2:
                    $this->responses['responses'][$question] = 1;
                    break;
                case 3:
                    $this->responses['responses'][$question] = 0;
                    break;
            }      
        }
    }


    private function CalculateFacets(){

        foreach($this->facets as $facet => $details){

            foreach($details['questions'] as $question){
                
                $this->facets[$facet]['raw'] += $this->responses['responses'][$question];
            }

            $this->facets[$facet]['average'] = ($this->facets[$facet]['raw'] / (count($this->facets[$facet]['questions'])));
            $this->facets[$facet]['average'] = round($this->facets[$facet]['average'],2);
        }
    }


    private function CalculateDomains(){
        foreach($this->domains as $domain => $details){

            foreach($details['facets'] as $facet){
                $this->domains[$domain]['raw'] += $this->facets[$facet]['average'];
            }
            
            $this->domains[$domain]['average'] = ($this->domains[$domain]['raw'] / (count($this->domains[$domain]['facets'])));
            $this->domains[$domain]['average'] = round( $this->domains[$domain]['average'],2);
        }
    }


    private function GenerateResponse(){
        $resultsArray = [
            'facets'=>$this->facets,
            'domains'=>$this->domains,
            'questions'=>$this->responses['responses']
        ];

        $this->results = json_encode($resultsArray);
    }
}
?>







